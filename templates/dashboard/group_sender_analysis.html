{% extends "base.html" %}

{% block title %}Group Sender Analysis - WhatsApp UI{% endblock %}

{% block content %}
<div class="dashboard-layout">
    <!-- Include User Left Sidebar from Layout File -->
    {% include 'user_slidebar.html' %}
    
    <!-- Main Content Area -->
    <div class="main-content">
        <div class="main-header">
            <div class="header-content">
                <h1><i class="fas fa-users"></i> Group Sender Analysis</h1>
                <p class="header-subtitle">Analyze message senders across WhatsApp groups and assemblies</p>
            </div>
            <div class="header-actions">
                <button class="btn btn-secondary" onclick="goBack()">
                    <i class="fas fa-arrow-left"></i> Back to Analysis
                </button>
                <button class="refresh-btn" onclick="location.reload()">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
        </div>
        
        <div class="dashboard-content">
            <!-- Analysis Form Section -->
            <div class="section-header">
                <h3><i class="fas fa-filter"></i> Analysis Filters</h3>
                <p>Select assemblies and date range to analyze group sender statistics</p>
            </div>
            
            <!-- Analysis Form -->
            <div class="analysis-form" id="analysisForm">
                <!-- Filter Form Header with Collapse/Expand -->
                <div class="filter-form-header">
                    <div class="filter-form-title">
                        <i class="fas fa-filter"></i>
                        <span>Current Filter Settings</span>
                    </div>
                    <div class="filter-form-actions">
                        <button type="button" class="btn btn-outline btn-sm" id="toggleFilterBtn" onclick="toggleFilterForm()">
                            <i class="fas fa-chevron-up"></i> Hide Filters
                        </button>
                    </div>
                </div>
                
                <!-- Filter Form Content -->
                <div class="filter-form-content" id="filterFormContent">
                <div class="form-row">
                    <!-- Assembly Selection -->
                    <div class="form-group">
                        <label for="assemblyDropdown">
                            <i class="fas fa-building"></i> Select Assemblies
                        </label>
                        <div class="custom-dropdown-container">
                            <div class="custom-dropdown" id="assemblyDropdown">
                                <div class="dropdown-header" onclick="toggleDropdown()">
                                    <span class="dropdown-placeholder">Select assemblies...</span>
                                    <i class="fas fa-chevron-down dropdown-arrow"></i>
                                </div>
                                <div class="dropdown-content" id="dropdownContent">
                                    <div class="dropdown-search">
                                        <input type="text" id="assemblySearch" placeholder="Search assemblies..." onkeyup="filterAssemblies()">
                                        <i class="fas fa-search search-icon"></i>
                                    </div>
                                    <div class="dropdown-options" id="dropdownOptions">
                                        <div class="loading-spinner">
                                            <i class="fas fa-spinner fa-spin"></i> Loading assemblies...
                                        </div>
                                    </div>
                                    <div class="dropdown-actions">
                                        <button type="button" class="btn-select-all" onclick="selectAllAssemblies()">
                                            <i class="fas fa-check-double"></i> Select All
                                        </button>
                                        <button type="button" class="btn-clear-all" onclick="clearAllAssemblies()">
                                            <i class="fas fa-times"></i> Clear All
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="selected-assemblies" id="selectedAssemblies">
                                <!-- Selected assemblies will be displayed here -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="form-row">
                    <!-- Quick Date Filters -->
                    <div class="form-group">
                        <label>
                            <i class="fas fa-clock"></i> Quick Date Filters
                        </label>
                        <div class="quick-date-filters">
                            <label class="quick-filter-checkbox">
                                <input type="radio" name="quickFilter" value="1week" onchange="setQuickDateRange('1week')">
                                <span class="filter-label">1 Week</span>
                            </label>
                            <label class="quick-filter-checkbox">
                                <input type="radio" name="quickFilter" value="1month" onchange="setQuickDateRange('1month')">
                                <span class="filter-label">1 Month</span>
                            </label>
                            <label class="quick-filter-checkbox">
                                <input type="radio" name="quickFilter" value="3months" onchange="setQuickDateRange('3months')">
                                <span class="filter-label">3 Months</span>
                            </label>
                            <label class="quick-filter-checkbox">
                                <input type="radio" name="quickFilter" value="6months" onchange="setQuickDateRange('6months')">
                                <span class="filter-label">6 Months</span>
                            </label>
                            <label class="quick-filter-checkbox">
                                <input type="radio" name="quickFilter" value="1year" onchange="setQuickDateRange('1year')">
                                <span class="filter-label">1 Year</span>
                            </label>
                            <label class="quick-filter-checkbox">
                                <input type="radio" name="quickFilter" value="custom" onchange="setQuickDateRange('custom')" checked>
                                <span class="filter-label">Custom Range</span>
                            </label>
                        </div>
                    </div>
                </div>
                
                <div class="form-row">
                    <!-- Date Range Selection -->
                    <div class="form-group">
                        <label for="startDate">
                            <i class="fas fa-calendar"></i> Start Date <span class="required">*</span>
                        </label>
                        <input type="date" id="startDate" name="startDate" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="endDate">
                            <i class="fas fa-calendar"></i> End Date <span class="optional">(Optional)</span>
                        </label>
                        <input type="date" id="endDate" name="endDate">
                    </div>
                </div>
                
                <!-- Sentiment Filter -->
                <div class="form-row">
                    <div class="form-group">
                        <label for="sentiment">
                            <i class="fas fa-heart"></i> Sentiment Filter
                        </label>
                        <select id="sentiment" class="form-control">
                            <option value="all">All Sentiments</option>
                            <option value="positive">Positive</option>
                            <option value="negative">Negative</option>
                            <option value="neutral">Neutral</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-primary" onclick="analyzeGroupSenders()">
                        <i class="fas fa-chart-bar"></i> Analyze Group Senders
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="clearAnalysis()">
                        <i class="fas fa-times"></i> Clear
                    </button>
                </div>
                </div> <!-- End of filter-form-content -->
                
                <!-- Show Filters Button (hidden by default) -->
                <div class="show-filters-section" id="showFiltersSection" style="display: none;">
                    <button type="button" class="btn btn-primary btn-show-filters" onclick="showFilterForm()">
                        <i class="fas fa-filter"></i> Show Filters for New Analysis
                    </button>
                </div>
            </div>
            
            <!-- Group Sender Analysis Results -->
            <div class="group-sender-results" id="groupSenderResults" style="display: none;">
                <div class="section-header">
                    <h3><i class="fas fa-users"></i> Group Sender Analysis Results</h3>
                </div>
                
                <div class="sender-summary">
                    <div class="summary-card total-groups">
                        <div class="summary-icon">
                            <i class="fas fa-layer-group"></i>
                        </div>
                        <div class="summary-content">
                            <h4>Total Groups</h4>
                            <span class="summary-value" id="totalGroupsCount">0</span>
                        </div>
                    </div>
                    
                    <div class="summary-card total-senders">
                        <div class="summary-icon">
                            <i class="fas fa-user-friends"></i>
                        </div>
                        <div class="summary-content">
                            <h4>Total Unique Senders</h4>
                            <span class="summary-value" id="totalSendersCount">0</span>
                        </div>
                    </div>
                    
                    <div class="summary-card total-messages">
                        <div class="summary-icon">
                            <i class="fas fa-comments"></i>
                        </div>
                        <div class="summary-content">
                            <h4>Total Messages</h4>
                            <span class="summary-value" id="totalMessagesCount">0</span>
                        </div>
                    </div>
                </div>
                
                <!-- Group Analysis Table -->
                <div class="group-analysis-section">
                    <h4><i class="fas fa-table"></i> Group Analysis</h4>
                    
                    <!-- Table Controls -->
                    <div class="table-controls">
                        <div class="table-info">
                            <span id="tableInfo">Showing 0 of 0 groups</span>
                        </div>
                        <div class="table-actions">
                            <button type="button" class="btn btn-outline btn-sm" onclick="exportGroupAnalysis()">
                                <i class="fas fa-download"></i> Export Table
                            </button>
                        </div>
                    </div>
                    
                    <div class="group-analysis-container">
                        <table class="group-analysis-table">
                            <thead>
                                <tr>
                                    <th>Group Name</th>
                                    <th>Assembly</th>
                                    <th>Date</th>
                                    <th>Total Messages</th>
                                    <th>Unique Senders</th>
                                    <th>Top Sender</th>
                                    <th>Sentiment Breakdown</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="groupAnalysisTableBody">
                                <!-- Group analysis will be populated here -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Pagination Controls -->
                    <div class="pagination-container" id="paginationContainer" style="display: none;">
                        <div class="pagination-info">
                            <span id="paginationInfo">Page 1 of 1</span>
                        </div>
                        <div class="pagination-controls">
                            <button type="button" class="btn btn-outline btn-sm" id="prevPageBtn" onclick="previousPage()" disabled>
                                <i class="fas fa-chevron-left"></i> Previous
                            </button>
                            <div class="page-numbers" id="pageNumbers">
                                <!-- Page numbers will be generated here -->
                            </div>
                            <button type="button" class="btn btn-outline btn-sm" id="nextPageBtn" onclick="nextPage()" disabled>
                                Next <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                        <div class="pagination-settings">
                            <label for="itemsPerPage">Items per page:</label>
                            <select id="itemsPerPage" onchange="changeItemsPerPage()">
                                <option value="15" selected>15</option>
                                <option value="25">25</option>
                                <option value="50">50</option>
                                <option value="100">100</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Search and Filter Section -->
            <div class="search-filter-section" id="searchFilterSection" style="display: none;">
                <div class="section-header">
                    <h4><i class="fas fa-search"></i> Search Across All Messages</h4>
                    <p>Search through messages from all groups and assemblies</p>
                    
                                            <!-- Permanent Download Buttons -->
                        <div class="permanent-download-section">
                            <div class="download-buttons-row">
                                <button class="btn btn-success" onclick="exportPositiveUsersExcel()">
                                    <i class="fas fa-smile"></i> Export Most Positive Users (Excel)
                                </button>
                                <button class="btn btn-danger" onclick="exportNegativeUsersExcel()">
                                    <i class="fas fa-frown"></i> Export Most Negative Users (Excel)
                                </button>
                            </div>
                            <p class="download-info">Download lists of most positive and negative active users with their sentiment analysis</p>
                        </div>
                </div>
                
                <div class="search-controls">
                    <!-- Search Field Selector -->
                    <div class="search-field-control">
                        <label for="searchField">
                            <i class="fas fa-filter"></i> Search In
                        </label>
                        <select id="searchField" onchange="updateSearchPlaceholder()">
                            <option value="messageContent">Message Content</option>
                            <option value="senderName">Sender Name</option>
                            <option value="senderPhone">Sender Phone</option>
                            <option value="groupName">Group Name</option>
                            <option value="assembly">Assembly</option>
                            <option value="all">All Fields</option>
                        </select>
                    </div>
                    
                    <!-- Search Input -->
                    <div class="search-control">
                        <label for="messageSearch">
                            <i class="fas fa-search"></i> Search Messages
                        </label>
                        <input 
                            type="text" 
                            id="messageSearch" 
                            placeholder="Search in message content... (Press Enter or Click Search)"
                            onkeypress="handleSearchKeypress(event)"
                        >
                    </div>
                    
                    <!-- Search Submit Button -->
                    <div class="search-submit-control">
                        <button type="button" class="btn btn-primary" onclick="submitSearch()">
                            <i class="fas fa-search"></i> Search
                        </button>
                    </div>
                    
                    <!-- Label Filter -->
                    <div class="label-filter-control">
                        <label for="labelFilter">
                            <i class="fas fa-tags"></i> Filter by Label
                        </label>
                        <select id="labelFilter" onchange="filterByLabel()">
                            <option value="all">All Labels</option>
                            <!-- Labels will be populated dynamically -->
                        </select>
                    </div>
                    
                    <!-- Sentiment Filter -->
                    <div class="search-sentiment-filter-control">
                        <label for="sentimentFilter">
                            <i class="fas fa-smile"></i> Filter by Sentiment
                        </label>
                        <select id="sentimentFilter" onchange="filterBySentiment()">
                            <option value="all">All Sentiments</option>
                            <option value="positive">Positive Only</option>
                            <option value="negative">Negative Only</option>
                            <option value="neutral">Neutral Only</option>
                        </select>
                    </div>
                    
                    <!-- Clear Filters Button -->
                    <div class="clear-filters-control">
                        <button class="btn btn-outline" onclick="clearAllFilters()">
                            <i class="fas fa-times"></i> Clear All Filters
                        </button>
                    </div>
                </div>
                
                <!-- Search Results Summary -->
                <div class="search-results-summary" id="searchResultsSummary" style="display: none;">
                    <div class="summary-stats">
                        <span class="stat-item">
                            <i class="fas fa-search"></i>
                            <span id="searchResultsCount">0</span> messages found
                        </span>
                        <span class="stat-item">
                            <i class="fas fa-users"></i>
                            <span id="searchResultsMembers">0</span> members
                        </span>
                        <span class="stat-item">
                            <i class="fas fa-layer-group"></i>
                            <span id="searchResultsGroups">0</span> groups
                        </span>
                    </div>
                    
                    <!-- Download Button -->
                    <div class="download-section">
                        <button id="downloadSearchResultsBtn" class="btn btn-success" onclick="downloadSearchResults()" style="display: none;">
                            <i class="fas fa-download"></i> Download Results (Excel)
                        </button>
                        
                        <!-- Test Download Button (temporary) -->
                        <button class="btn btn-warning" onclick="testDownload()" style="margin-left: 10px;">
                            <i class="fas fa-bug"></i> Test Download
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Loading State -->
            <div class="loading-state" id="loadingState" style="display: none;">
                <div class="loading-content">
                    <i class="fas fa-spinner fa-spin"></i>
                    <h3>Analyzing Group Senders...</h3>
                    <p>Please wait while we process your data</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Include CSS -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/group_sender_analysis.css') }}">

<!-- Include JavaScript -->
<script src="{{ url_for('static', filename='js/group_sender_analysis.js') }}"></script>
{% endblock %}
